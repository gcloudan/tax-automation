{
  "name": "Tax Pipeline V2 — PDF + Google Sheets",
  "nodes": [
    {
      "parameters": {
        "pollTimes": { "item": [{ "mode": "everyMinute" }] },
        "simple": false,
        "filters": {},
        "options": { "downloadAttachments": true }
      },
      "type": "n8n-nodes-base.gmailTrigger",
      "typeVersion": 1.3,
      "position": [-500, 0],
      "id": "gmail-trigger",
      "name": "Gmail Trigger",
      "credentials": {
        "gmailOAuth2": { "id": "CpLr1b6KbJP040PV", "name": "Gmail account" }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": false },
          "conditions": [
            {
              "leftValue": "={{ $json.attachments ? $json.attachments.length : 0 }}",
              "rightValue": 0,
              "operator": { "type": "number", "operation": "gt" }
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [-260, 0],
      "id": "has-attachment",
      "name": "Has PDF Attachment?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://pdf-service:8001/extract",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "={{ $json.attachments[0].data }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.4,
      "position": [-20, -120],
      "id": "pdf-extract",
      "name": "Extract PDF Text"
    },
    {
      "parameters": {
        "jsCode": "// Merge PDF extraction result back with original email data\nconst emailData = $('Gmail Trigger').first().json;\nconst pdfData = $input.first().json;\n\nreturn {\n  subject: emailData.subject,\n  emailBody: emailData.html || emailData.text || emailData.snippet || '',\n  pdfText: pdfData.text || '',\n  pdfAmounts: pdfData.amounts_aud || [],\n  vendorHint: pdfData.vendor_hint || '',\n  hasPdf: true\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [200, -120],
      "id": "merge-pdf",
      "name": "Merge PDF + Email"
    },
    {
      "parameters": {
        "jsCode": "// No PDF — just pass email body through\nconst emailData = $input.first().json;\nreturn {\n  subject: emailData.subject,\n  emailBody: emailData.html || emailData.text || emailData.snippet || '',\n  pdfText: '',\n  pdfAmounts: [],\n  vendorHint: '',\n  hasPdf: false\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-20, 120],
      "id": "no-pdf-passthrough",
      "name": "Email Only (No PDF)"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [420, 0],
      "id": "merge-branches",
      "name": "Merge Branches"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "Bearer {{ $env.OPENROUTER_API_KEY }}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"arcee-ai/trinity-large-preview:free\",\n  \"response_format\": { \"type\": \"json_object\" },\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"You are a Tax Data Entry Assistant for a Cloud Engineer. Your goal is to capture EVERYTHING that has even a 1% chance of being deductible.\\n\\nSCORING RULES:\\n- If vendor is (AliExpress, Amazon, Bunnings, Apple, JB Hi-Fi, Jaycar, DigitalOcean, AWS, or any SaaS): Base Probability = 70%.\\n- If dollar amount ($) is found in email body OR PDF text: Add 30% to probability.\\n- If only a 'Download Invoice' button is found: Base Probability = 50% (Mark as 'Pending PDF').\\n\\nCATEGORY RULES:\\n- Tech/Electronics/Cables/SaaS/Homelab -> D5 (Work Related)\\n- Tools/Hardware/Plumbing/Maintenance/Rental -> Item 21 (Rental Property)\\n\\nDEPRECIATION: If a single item costs over $300 AUD, set depreciation_required to true.\\n\\nRespond strictly in JSON:\\n{\\n  \\\"potential_deduction\\\": boolean,\\n  \\\"probability_score\\\": \\\"string (e.g. 80%)\\\",\\n  \\\"ato_code\\\": \\\"string\\\",\\n  \\\"vendor\\\": \\\"string\\\",\\n  \\\"total_amount_aud\\\": number (0 if not found),\\n  \\\"depreciation_required\\\": boolean,\\n  \\\"status\\\": \\\"Verified\\\" | \\\"Pending PDF Extraction\\\" | \\\"Requires Manual Check\\\",\\n  \\\"brief_reason\\\": \\\"Why you caught this\\\"\\n}\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": {{ JSON.stringify(\n        \"Subject: \" + $json.subject +\n        \"\\nEmail Body: \" + ($json.emailBody || '').substring(0, 3000) +\n        ($json.pdfText ? \"\\n\\nPDF INVOICE TEXT:\\n\" + $json.pdfText.substring(0, 4000) : '') +\n        ($json.pdfAmounts.length > 0 ? \"\\n\\nAUD Amounts found in PDF: \" + $json.pdfAmounts.join(', ') : '')\n      ) }}\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.4,
      "position": [640, 0],
      "id": "ai-triage",
      "name": "AI Triage (OpenRouter)"
    },
    {
      "parameters": {
        "jsCode": "const rawText = $input.first().json.choices[0].message.content;\nconst parsed = JSON.parse(rawText);\n\n// Inject financial year and original subject for Sheets logging\nconst emailData = $('Gmail Trigger').first().json;\nparsed.source_subject = emailData.subject || '';\nparsed.financial_year = 'FY2024-25';\nparsed.date_logged = new Date().toISOString().split('T')[0];\n\nreturn parsed;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [860, 0],
      "id": "parse-ai-json",
      "name": "Parse AI JSON"
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {\n              \"leftValue\": \"={{ $json.potential_deduction }}\",\n              \"rightValue\": true,\n              \"operator\": { \"type\": \"boolean\", \"operation\": \"equals\" }\n            }\n          ]\n        }\n      },\n      \"type\": \"n8n-nodes-base.if\",\n      \"typeVersion\": 2,\n      \"position\": [1080, 0],\n      \"id\": \"is-potential\",\n      \"name\": \"Is Potential Deduction?\"\n    },\n    {\n      \"parameters\": {\n        \"operation\": \"append\",\n        \"documentId\": { \"__rl\": true, \"value\": \"={{ $env.GOOGLE_SHEET_ID }}\", \"mode\": \"id\" },\n        \"sheetName\": { \"__rl\": true, \"value\": \"ATO Deductions 2025\", \"mode\": \"name\" },\n        \"columns\": {\n          \"mappingMode\": \"defineBelow\",\n          \"value\": {\n            \"Date Logged\": \"={{ $json.date_logged }}\",\n            \"Vendor\": \"={{ $json.vendor }}\",\n            \"Amount (AUD)\": \"={{ $json.total_amount_aud }}\",\n            \"ATO Code\": \"={{ $json.ato_code }}\",\n            \"Probability\": \"={{ $json.probability_score }}\",\n            \"Status\": \"={{ $json.status }}\",\n            \"AI Reason\": \"={{ $json.brief_reason }}\",\n            \"Source Email Subject\": \"={{ $json.source_subject }}\",\n            \"Depreciation Flag\": \"={{ $json.depreciation_required }}\",\n            \"Financial Year\": \"={{ $json.financial_year }}\"\n          }\n        },\n        \"options\": {}\n      },\n      \"type\": \"n8n-nodes-base.googleSheets\",\n      \"typeVersion\": 4.4,\n      \"position\": [1300, -120],\n      \"id\": \"sheets-append\",\n      \"name\": \"Log to Google Sheets\",\n      \"credentials\": {\n        \"googleSheetsOAuth2Api\": { \"id\": \"REPLACE_WITH_YOUR_SHEETS_CRED_ID\", \"name\": \"Google Sheets account\" }\n      }\n    },\n    {\n      \"parameters\": {\n        \"conditions\": {\n          \"conditions\": [\n            {\n              \"leftValue\": \"={{ $json.status }}\",\n              \"rightValue\": \"Requires Manual Check\",\n              \"operator\": { \"type\": \"string\", \"operation\": \"equals\" }\n            }\n          ]\n        }\n      },\n      \"type\": \"n8n-nodes-base.if\",\n      \"typeVersion\": 2,\n      \"position\": [1520, -120],\n      \"id\": \"needs-alert\",\n      \"name\": \"Needs Manual Alert?\"\n    },\n    {\n      \"parameters\": {\n        \"sendTo\": \"taxdtran@gmail.com\",\n        \"subject\": \"=⚠️ Manual Check: {{$json.vendor}} ({{$json.probability_score}})\",\n        \"message\": \"=<h2>⚠️ Manual Check Required</h2>\\n<ul>\\n  <li><b>Vendor:</b> {{$json.vendor}}</li>\\n  <li><b>Amount:</b> ${{$json.total_amount_aud}}</li>\\n  <li><b>ATO Code:</b> {{$json.ato_code}}</li>\\n  <li><b>Probability:</b> {{$json.probability_score}}</li>\\n  <li><b>Status:</b> <span style='color:#d32f2f;font-weight:bold;'>{{$json.status}}</span></li>\\n  <li><b>Depreciation Required:</b> {{$json.depreciation_required}}</li>\\n</ul>\\n<h3>AI Reason</h3><p>{{$json.brief_reason}}</p>\\n<hr><p><small>Logged to Google Sheets. Review the PDF manually.</small></p>\",\n        \"options\": {}\n      },\n      \"type\": \"n8n-nodes-base.gmail\",\n      \"typeVersion\": 2.2,\n      \"position\": [1740, -220],\n      \"id\": \"alert-email\",\n      \"name\": \"Send Manual Check Alert\",\n      \"credentials\": {\n        \"gmailOAuth2\": { \"id\": \"CpLr1b6KbJP040PV\", \"name\": \"Gmail account\" }\n      }\n    },\n    {\n      \"parameters\": {\n        \"operation\": \"markAsRead\",\n        \"messageId\": \"={{ $node['Gmail Trigger'].json.id }}\"\n      },\n      \"type\": \"n8n-nodes-base.gmail\",\n      \"typeVersion\": 2.2,\n      \"position\": [1960, 0],\n      \"id\": \"mark-read\",\n      \"name\": \"Mark as Read\",\n      \"credentials\": {\n        \"gmailOAuth2\": { \"id\": \"CpLr1b6KbJP040PV\", \"name\": \"Gmail account\" }\n      }\n    }\n  ],\n  \"connections\": {\n    \"Gmail Trigger\": { \"main\": [[{ \"node\": \"Has PDF Attachment?\", \"type\": \"main\", \"index\": 0 }]] },\n    \"Has PDF Attachment?\": {\n      \"main\": [\n        [{ \"node\": \"Extract PDF Text\", \"type\": \"main\", \"index\": 0 }],\n        [{ \"node\": \"Email Only (No PDF)\", \"type\": \"main\", \"index\": 0 }]\n      ]\n    },\n    \"Extract PDF Text\": { \"main\": [[{ \"node\": \"Merge PDF + Email\", \"type\": \"main\", \"index\": 0 }]] },\n    \"Merge PDF + Email\": { \"main\": [[{ \"node\": \"Merge Branches\", \"type\": \"main\", \"index\": 0 }]] },\n    \"Email Only (No PDF)\": { \"main\": [[{ \"node\": \"Merge Branches\", \"type\": \"main\", \"index\": 1 }]] },\n    \"Merge Branches\": { \"main\": [[{ \"node\": \"AI Triage (OpenRouter)\", \"type\": \"main\", \"index\": 0 }]] },\n    \"AI Triage (OpenRouter)\": { \"main\": [[{ \"node\": \"Parse AI JSON\", \"type\": \"main\", \"index\": 0 }]] },\n    \"Parse AI JSON\": { \"main\": [[{ \"node\": \"Is Potential Deduction?\", \"type\": \"main\", \"index\": 0 }]] },\n    \"Is Potential Deduction?\": {\n      \"main\": [\n        [{ \"node\": \"Log to Google Sheets\", \"type\": \"main\", \"index\": 0 }],\n        [{ \"node\": \"Mark as Read\", \"type\": \"main\", \"index\": 0 }]\n      ]\n    },\n    \"Log to Google Sheets\": { \"main\": [[{ \"node\": \"Needs Manual Alert?\", \"type\": \"main\", \"index\": 0 }]] },\n    \"Needs Manual Alert?\": {\n      \"main\": [\n        [{ \"node\": \"Send Manual Check Alert\", \"type\": \"main\", \"index\": 0 }],\n        [{ \"node\": \"Mark as Read\", \"type\": \"main\", \"index\": 0 }]\n      ]\n    },\n    \"Send Manual Check Alert\": { \"main\": [[{ \"node\": \"Mark as Read\", \"type\": \"main\", \"index\": 0 }]] }\n  },\n  \"pinData\": {},\n  \"meta\": { \"templateCredsSetupCompleted\": false }\n}
